<div class="tab-content">
  <h2>Convert Test Case to Cucumber Script</h2>
  
  <div *ngIf="!uploadedDocument" class="info-message">
    <p>Please upload a BRD document first.</p>
  </div>

  <div *ngIf="uploadedDocument" class="content">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Enter the test case text here</mat-label>
      <textarea matInput [(ngModel)]="testCaseText" rows="8" class="textarea"></textarea>
    </mat-form-field>

    <button mat-raised-button color="primary btn-gradient" (click)="generateCucumber()" [disabled]="isLoading || !testCaseText">
      {{ isLoading ? 'Generating...' : 'Generate Cucumber Script' }}
    </button>

    <mat-spinner *ngIf="isLoading" diameter="40" class="spinner"></mat-spinner>

    <div *ngIf="cucumberScript" class="results">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Generated Cucumber Script</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="code-toolbar">
            <div class="left"> 
              <small *ngIf="uploadedDocument">File: {{ uploadedDocument.documentId }} </small>
            </div>
            <div class="right">
              <button mat-icon-button matTooltip="Copy all" (click)="copyToClipboard(cucumberScript!, 'all')"><mat-icon>content_copy</mat-icon></button>
              <span class="copied-badge" *ngIf="copied.all">Copied</span>
              <button mat-icon-button matTooltip="Download all" (click)="downloadFile((uploadedDocument ? uploadedDocument.documentId : 'cucumber') + '.txt', cucumberScript)"><mat-icon>download</mat-icon></button>
            </div>
          </div>

          <!-- If parser extracted parts, show them separately -->
          <div *ngIf="featureText">
            <div class="sub-card">
              <div class="sub-card-header">
                <h3>Feature File</h3>
                <div class="sub-actions">
                  <button mat-icon-button matTooltip="Copy feature" (click)="copyToClipboard(featureText, 'feature')"><mat-icon>content_copy</mat-icon></button>
                  <span class="copied-badge" *ngIf="copied.feature">Copied</span>
                  <button mat-icon-button matTooltip="Download .feature" (click)="downloadFile((uploadedDocument ? uploadedDocument.documentId : 'feature') + '.feature', featureText)"><mat-icon>download</mat-icon></button>
                </div>
              </div>
              <pre class="code-block" data-role="feature">{{ featureText }}</pre>
            </div>
          </div>

          <div *ngIf="stepsText">
            <div class="sub-card">
              <div class="sub-card-header">
                <h3>Step Definitions</h3>
                <div class="sub-actions">
                  <button mat-icon-button matTooltip="Copy steps" (click)="copyToClipboard(stepsText, 'steps')"><mat-icon>content_copy</mat-icon></button>
                  <span class="copied-badge" *ngIf="copied.steps">Copied</span>
                  <button mat-icon-button matTooltip="Download .java" (click)="downloadFile((uploadedDocument ? uploadedDocument.documentId : 'steps') + 'Steps.java', stepsText)"><mat-icon>download</mat-icon></button>
                </div>
              </div>
              <pre class="code-block" data-role="steps">{{ stepsText }}</pre>
            </div>
          </div>

          <!-- Fallback: show raw script if parser didn't separate parts -->
          <div *ngIf="!featureText && !stepsText">
            <pre class="code-block">{{ cucumberScript }}</pre>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="qa-card" *ngIf="qualityAssessment">
        <mat-card-header>
          <mat-card-title>Quality Assessment</mat-card-title>
          <div class="qa-help-icon">
            <button mat-icon-button matTooltip="QA help" (click)="openQaHelp()"><mat-icon>help_outline</mat-icon></button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div class="qa-grid">
            <div class="qa-overall">
              <div class="qa-score-wrap" [class.pulse]="pulse">
                <svg class="qa-ring" [attr.width]="(ringRadius*2 + ringStroke)" [attr.height]="(ringRadius*2 + ringStroke)" [attr.viewBox]="'0 0 ' + (ringRadius*2 + ringStroke) + ' ' + (ringRadius*2 + ringStroke)">
                  <defs>
                    <linearGradient id="qaGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#4caf50" />
                      <stop offset="50%" stop-color="#f6a000" />
                      <stop offset="100%" stop-color="#d32f2f" />
                    </linearGradient>
                  </defs>
                  <circle class="ring-bg" [attr.cx]="ringRadius + ringStroke/2" [attr.cy]="ringRadius + ringStroke/2" [attr.r]="ringRadius" [attr.stroke-width]="ringStroke" fill="none" stroke="#e6e6e6"></circle>
                  <circle class="ring" [attr.cx]="ringRadius + ringStroke/2" [attr.cy]="ringRadius + ringStroke/2" [attr.r]="ringRadius" [attr.stroke-width]="ringStroke" fill="none" [attr.stroke]="getLevelColor(qualityAssessment.overall_level || qualityAssessment.overallLevel)" [attr.stroke-dasharray]="circumference" [attr.stroke-dashoffset]="getStrokeDashoffset(qualityAssessment.overall_score || qualityAssessment.score)" stroke-linecap="round"></circle>
                  <!-- thinner arc overlay for emphasis with gradient -->
                  <circle class="ring-arc" [attr.cx]="ringRadius + ringStroke/2" [attr.cy]="ringRadius + ringStroke/2" [attr.r]="ringRadius" [attr.stroke-width]="4" fill="none" stroke="url(#qaGrad)" [attr.stroke-dasharray]="circumference" [attr.stroke-dashoffset]="getStrokeDashoffset(qualityAssessment.overall_score || qualityAssessment.score)" stroke-linecap="round"></circle>
                </svg>
                <div class="qa-score-overlay">
                  <div class="qa-score">{{ getScorePercent(qualityAssessment.overall_score || qualityAssessment.score) }}</div>
                  <div class="qa-label">Overall</div>
                </div>
              </div>
              <div class="qa-level" [style.color]="getLevelColor(qualityAssessment.overall_level || qualityAssessment.overallLevel)">
                {{ (qualityAssessment.overall_level || qualityAssessment.overallLevel || 'Unknown') }}
              </div>
            </div>

            <div class="qa-metrics">
              <div class="metric-row" *ngIf="qualityAssessment.confidence_score !== undefined || qualityAssessment.confidence_score !== null">
                <div class="metric-label">Confidence <mat-icon matTooltip="Model's confidence in the generated script quality" class="info-icon">info</mat-icon></div>
                <div class="metric-bar">
                  <div class="metric-fill" [style.width]="getScorePercent(qualityAssessment.confidence_score) + '%'" [style.backgroundColor]="getLevelColor(qualityAssessment.confidence_level || qualityAssessment.confidenceLevel)"></div>
                </div>
                <div class="metric-value">{{ getScorePercent(qualityAssessment.confidence_score) }}%</div>
              </div>

              <div class="metric-row" *ngIf="qualityAssessment.match_score !== undefined || qualityAssessment.match_score !== null">
                <div class="metric-label">Match <mat-icon matTooltip="How closely the output matches expected format/spec" class="info-icon">info</mat-icon></div>
                <div class="metric-bar">
                  <div class="metric-fill" [style.width]="getScorePercent(qualityAssessment.match_score) + '%'" [style.backgroundColor]="getLevelColor(qualityAssessment.match_level || qualityAssessment.matchLevel)"></div>
                </div>
                <div class="metric-value">{{ getScorePercent(qualityAssessment.match_score) }}%</div>
              </div>

              <div class="qa-list">
                <div class="qa-item"><strong>Overall Score:</strong> <span>{{ qualityAssessment.overall_score || qualityAssessment.score || 'N/A' }}</span></div>
                <div class="qa-item" *ngIf="qualityAssessment.confidence_score !== undefined"><strong>Confidence Score:</strong> <span>{{ qualityAssessment.confidence_score }}</span></div>
                <div class="qa-item" *ngIf="qualityAssessment.match_score !== undefined"><strong>Match Score:</strong> <span>{{ qualityAssessment.match_score }}</span></div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <p class="processing-time" *ngIf="processingTime !== null">
        <strong>Processing time:</strong> {{ processingTime }} seconds
      </p>
    </div>
  </div>
</div>
