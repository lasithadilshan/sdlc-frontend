<div class="tab-content">
  <h2>User Story to Test Case</h2>
  
  <div *ngIf="!uploadedDocument" class="info-message">
    <p>Please upload a BRD document first.</p>
  </div>

  <div *ngIf="uploadedDocument" class="content">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Enter the user story text here</mat-label>
      <textarea matInput [(ngModel)]="userStoryText" rows="8" class="textarea"></textarea>
    </mat-form-field>

    <button mat-raised-button color="primary btn-gradient" (click)="generateTestCases()" [disabled]="isLoading || !userStoryText">
      {{ isLoading ? 'Generating...' : 'Generate Test Cases' }}
    </button>
    <button *ngIf="testCases" mat-stroked-button color="accent" class="export-btn" (click)="exportToPdf()" [disabled]="isLoading || isExporting || (isArray(testCases) && testCases.length === 0)" style="float:right">
      Export as PDF
    </button>

    <!-- Advanced AI Generation Animation -->
    <div *ngIf="isLoading" class="ai-loader">
      <div class="ai-container">
        <!-- Animated gradient background -->
        <div class="gradient-bg"></div>
        
        <!-- Floating particles -->
        <div class="particles">
          <div class="particle particle-1"></div>
          <div class="particle particle-2"></div>
          <div class="particle particle-3"></div>
          <div class="particle particle-4"></div>
          <div class="particle particle-5"></div>
        </div>
        
        <!-- Central rotating cube -->
        <div class="cube-container">
          <div class="cube">
            <div class="cube-face front">SDLC Mate</div>
            <div class="cube-face back"></div>
            <div class="cube-face right"></div>
            <div class="cube-face left"></div>
            <div class="cube-face top"></div>
            <div class="cube-face bottom"></div>
          </div>
        </div>
        
        <!-- Concentric animated circles -->
        <div class="circles">
          <div class="circle circle-1"></div>
          <div class="circle circle-2"></div>
          <div class="circle circle-3"></div>
        </div>
        
        <!-- Loading text with animation -->
        <div class="loading-text">
          <div class="text-pulse">Preparing your test cases...</div>
          <div class="dots-pulse">
            <span>.</span><span>.</span><span>.</span>
          </div>
        </div>
        
        <!-- Progress bar with flowing gradient -->
        <div class="progress-wrapper">
          <div class="progress-bar-animated"></div>
          <div class="progress-shimmer"></div>
        </div>
      </div>
    </div>

    <div *ngIf="isExporting" class="export-progress">
      <mat-progress-bar class="export-bar" mode="determinate" [value]="exportTotal ? (exportProgress / exportTotal) * 100 : 0"></mat-progress-bar>
      <div class="export-status">{{ exportProgress }} / {{ exportTotal }} (<span class="percent">{{ exportPercent }}%</span>)</div>
    </div>

    <div *ngIf="testCases" class="results">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Generated Test Cases</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="parseError" class="warning">
            <p>The model returned non-JSON output; showing raw text. Parse error: {{ parseError }}</p>
            <pre>{{ testCases }}</pre>
          </div>

          <!-- React-like UI replicated in Angular -->
          <div *ngIf="!parseError && testCases" class="tc-container">
            <div class="tc-grid" *ngIf="isArray(testCases); else singleCard">
              <div class="tc-card" *ngFor="let tc of testCases; let i = index">
                <div class="tc-colorbar"></div>
                <div class="tc-body">
                  <div class="tc-head">
                    <span class="tc-id">{{ tc.id || tc.ID || ('TC_' + (i + 1)) }}</span>
                    <span class="tc-priority" *ngIf="tc.priority">{{ tc.priority }}</span>
                  </div>

                  <h2 class="tc-title">{{ tc.title || tc.name || ('Test Case ' + (i + 1)) }}</h2>

                  <div class="tc-section tc-pre" *ngIf="tc.preconditions">
                    <div class="tc-section-title"><span class="tc-icon">‚ö†Ô∏è</span> Preconditions</div>
                    <ul class="tc-bullets">
                      <li *ngFor="let pre of (isArray(tc.preconditions) ? tc.preconditions : [tc.preconditions])">{{ pre }}</li>
                    </ul>
                  </div>

                  <div class="tc-section tc-data" *ngIf="tc.test_data">
                    <div class="tc-section-title"><span class="tc-icon">üóÑÔ∏è</span> Test Data</div>
                    <ul class="tc-data-list">
                      <li *ngFor="let data of (isArray(tc.test_data) ? tc.test_data : [tc.test_data])">{{ data }}</li>
                    </ul>
                  </div>

                  <div class="tc-section tc-steps" *ngIf="tc.test_steps || tc.steps">
                    <div class="tc-section-title"><span class="tc-icon">üìÑ</span> Test Steps</div>
                    <ol class="tc-steps-list">
                      <li *ngFor="let step of (isArray(tc.test_steps || tc.steps) ? (tc.test_steps || tc.steps) : [tc.test_steps || tc.steps]); let idx = index">
                        <span class="tc-step-num">{{ idx + 1 }}.</span>
                        {{ step }}
                      </li>
                    </ol>
                  </div>

                  <div class="tc-section tc-expected" *ngIf="tc.expected_results || tc.expected || tc.expected_result || tc.expectedResult">
                    <div class="tc-section-title"><span class="tc-icon">‚úÖ</span> Expected Results</div>
                    <ul class="tc-expected-list">
                      <li *ngFor="let res of (isArray(tc.expected_results || tc.expected) ? (tc.expected_results || tc.expected) : [tc.expected_results || tc.expected])">
                        <span class="tc-check">‚úì</span>
                        {{ res || tc.expected_result || tc.expectedResult }}
                      </li>
                    </ul>
                  </div>

                  <div class="tc-actions">
                    <button mat-stroked-button color="primary btn-gradient-secondary" (click)="sendToCucumber(tc, i)">Send to Cucumber</button>
                    <button mat-stroked-button color="accent btn-gradient-secondary" (click)="sendToSelenium(tc, i)">Send to Selenium</button>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #singleCard>
              <div class="tc-grid">
                <div class="tc-card">
                  <div class="tc-colorbar"></div>
                  <div class="tc-body">
                    <div class="tc-head">
                      <span class="tc-id">{{ testCases.id || testCases.ID || 'TC_1' }}</span>
                      <span class="tc-priority" *ngIf="testCases.priority">{{ testCases.priority }}</span>
                    </div>

                    <h2 class="tc-title">{{ testCases.title || testCases.name || 'Test Case 1' }}</h2>

                    <div class="tc-section tc-pre" *ngIf="testCases.preconditions">
                      <div class="tc-section-title"><span class="tc-icon">‚ö†Ô∏è</span> Preconditions</div>
                      <ul class="tc-bullets">
                        <li *ngFor="let pre of (isArray(testCases.preconditions) ? testCases.preconditions : [testCases.preconditions])">{{ pre }}</li>
                      </ul>
                    </div>

                    <div class="tc-section tc-data" *ngIf="testCases.test_data">
                      <div class="tc-section-title"><span class="tc-icon">üóÑÔ∏è</span> Test Data</div>
                      <ul class="tc-data-list">
                        <li *ngFor="let data of (isArray(testCases.test_data) ? testCases.test_data : [testCases.test_data])">{{ data }}</li>
                      </ul>
                    </div>

                    <div class="tc-section tc-steps" *ngIf="testCases.test_steps || testCases.steps">
                      <div class="tc-section-title"><span class="tc-icon">üìÑ</span> Test Steps</div>
                      <ol class="tc-steps-list">
                        <li *ngFor="let step of (isArray(testCases.test_steps || testCases.steps) ? (testCases.test_steps || testCases.steps) : [testCases.test_steps || testCases.steps]); let idx = index">
                          <span class="tc-step-num">{{ idx + 1 }}.</span>
                          {{ step }}
                        </li>
                      </ol>
                    </div>

                    <div class="tc-section tc-expected" *ngIf="testCases.expected_results || testCases.expected || testCases.expected_result || testCases.expectedResult">
                      <div class="tc-section-title"><span class="tc-icon">‚úÖ</span> Expected Results</div>
                      <ul class="tc-expected-list">
                        <li *ngFor="let res of (isArray(testCases.expected_results || testCases.expected) ? (testCases.expected_results || testCases.expected) : [testCases.expected_results || testCases.expected])">
                          <span class="tc-check">‚úì</span>
                          {{ res || testCases.expected_result || testCases.expectedResult }}
                        </li>
                      </ul>
                    </div>

                    <div class="tc-actions">
                      <button mat-stroked-button color="primary btn-gradient-secondary" (click)="sendToCucumber(testCases, 0)">Send to Cucumber</button>
                      <button mat-stroked-button color="accent btn-gradient-secondary" (click)="sendToSelenium(testCases, 0)">Send to Selenium</button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-template>
          </div>

        </mat-card-content>
      </mat-card>

      <!-- Quality Assessment UI commented out
      <mat-card>
        ...quality assessment UI removed for now...
      </mat-card>
      -->

      <!-- Processing time removed -->
    </div>
  </div>
</div>
