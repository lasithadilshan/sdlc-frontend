<div class="tab-content">
  <h2>User Stories</h2>
  
  <div *ngIf="!uploadedDocument" class="info-message">
    <p>Please upload a BRD document in the sidebar to create user stories.</p>
  </div>

  <div *ngIf="uploadedDocument" class="content">
    <div class="row btn-row d-flex justify-content-between mb-3">
        <button mat-raised-button color="primary btn-gradient" (click)="generateUserStories()" [disabled]="isLoading">
          {{ isLoading ? 'Prepairing...' : 'Create User Stories' }}
        </button>
        <button *ngIf="(parsedUserStories.length || 0) > 0" mat-stroked-button color="accent" class="export-btn" (click)="exportToPdf()" [disabled]="isLoading || isExporting || (parsedUserStories.length || 0) === 0" style="float:right">
          Export as PDF
        </button>
        <!-- <button mat-flat-button color="primary" class="download-btn" (click)="exportToPdfDirect()" [disabled]="isLoading || isExporting || (parsedUserStories.length || 0) === 0">
          Download PDF
        </button> -->
    </div>
    

    <div *ngIf="isExporting" class="export-progress">
      <mat-progress-bar class="export-bar" mode="determinate" [value]="exportTotal ? (exportProgress / exportTotal) * 100 : 0"></mat-progress-bar>
      <div class="export-status">{{ exportProgress }} / {{ exportTotal }} (<span class="percent">{{ exportPercent }}%</span>)</div>
    </div>

    <!-- Advanced AI Generation Animation -->
    <div *ngIf="isLoading" class="ai-loader">
      <div class="ai-container">
        <!-- Animated gradient background -->
        <div class="gradient-bg"></div>
        
        <!-- Floating particles -->
        <div class="particles">
          <div class="particle particle-1"></div>
          <div class="particle particle-2"></div>
          <div class="particle particle-3"></div>
          <div class="particle particle-4"></div>
          <div class="particle particle-5"></div>
        </div>
        
        <!-- Central rotating cube -->
        <div class="cube-container">
          <div class="cube">
            <div class="cube-face front">SDLC Mate</div>
            <div class="cube-face back"></div>
            <div class="cube-face right"></div>
            <div class="cube-face left"></div>
            <div class="cube-face top"></div>
            <div class="cube-face bottom"></div>
          </div>
        </div>
        
        <!-- Concentric animated circles -->
        <div class="circles">
          <div class="circle circle-1"></div>
          <div class="circle circle-2"></div>
          <div class="circle circle-3"></div>
        </div>
        
        <!-- Loading text with animation -->
        <div class="loading-text">
          <div class="text-pulse">Preparing your user stories‚Ä¶</div>
          <div class="dots-pulse">
            <span>.</span><span>.</span><span>.</span>
          </div>
        </div>
        
        <!-- Progress bar with flowing gradient -->
        <div class="progress-wrapper">
          <div class="progress-bar-animated"></div>
          <div class="progress-shimmer"></div>
        </div>
      </div>
    </div>

    <div *ngIf="(parsedUserStories.length || 0) > 0 || parseError" class="results">
      <div *ngIf="parseError" class="warning-message">
        <p>The model returned non-JSON output; showing raw text. Parse error: {{ parseError }}</p>
        <pre>{{ userStories }}</pre>
      </div>

      <div *ngIf="(parsedUserStories.length || 0) > 0">
        <h3>Prepared User Stories</h3>
        <div class="user-stories-container">
          <mat-card *ngFor="let story of parsedUserStories; let i = index" class="user-story-card">
            <div class="card-head">
              <span class="id-badge">{{ story.id || story.ID || ('US_' + (i + 1)) }}</span>
              <span class="priority-pill" *ngIf="story.priority" [ngClass]="'priority-' + (story.priority | lowercase)">{{ story.priority }}</span>
            </div>

            <mat-card-content>
              <h4 class="story-title">{{ story.title || ('User Story ' + (i + 1)) }}</h4>

              <div class="story-summary" *ngIf="story.story">
                <div class="story-text">{{ story.story }}</div>
              </div>

              <div class="acceptance-box" *ngIf="story.acceptance_criteria">
                <div class="acceptance-title">Acceptance Criteria</div>
                <ul>
                  <li *ngFor="let criteria of (Array.isArray(story.acceptance_criteria) ? story.acceptance_criteria : [story.acceptance_criteria])">
                    <span class="check">‚úì</span>
                    <span class="criteria-text">{{ criteria }}</span>
                  </li>
                </ul>
              </div>

              <div class="meta-row">
                <div class="meta-col">
                  <div class="meta-label">STORY POINTS</div>
                  <div class="meta-value">{{ story.story_points ?? story.storyPoints ?? '-' }}</div>
                </div>
                <div class="meta-col right">
                  <div class="meta-label">CATEGORY</div>
                  <div class="meta-value"><span class="category-badge">{{ story.category || '-' }}</span></div>
                </div>
              </div>

              <div class="notes-box" *ngIf="story.notes">
                <div class="notes-title">üìù Notes</div>
                <ul>
                  <li *ngFor="let note of (Array.isArray(story.notes) ? story.notes : [story.notes])">{{ note }}</li>
                </ul>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Quality Assessment UI commented out
      <mat-card class="quality-assessment-card" *ngIf="qualityAssessment">
        ...quality assessment UI removed for now...
      </mat-card>
      -->

      <!-- Processing time removed -->
    </div>
  </div>
</div>
