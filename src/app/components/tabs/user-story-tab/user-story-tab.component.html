<div class="tab-content">
  <h2>User Stories</h2>
  
  <div *ngIf="!uploadedDocument" class="info-message">
    <p>Please upload a BRD document in the sidebar to generate user stories.</p>
  </div>

  <div *ngIf="uploadedDocument" class="content">
    <div class="row btn-row d-flex justify-content-between mb-3">
        <button mat-raised-button color="primary btn-gradient" (click)="generateUserStories()" [disabled]="isLoading">
          {{ isLoading ? 'Generating...' : 'Generate User Stories' }}
        </button>
        <button mat-stroked-button color="accent" class="export-btn" (click)="exportToPdf()" [disabled]="isLoading || isExporting || (parsedUserStories.length || 0) === 0">
          Export as PDF
        </button>
        <!-- <button mat-flat-button color="primary" class="download-btn" (click)="exportToPdfDirect()" [disabled]="isLoading || isExporting || (parsedUserStories.length || 0) === 0">
          Download PDF
        </button> -->
    </div>
    

    <div *ngIf="isExporting" class="export-progress">
      <mat-progress-bar class="export-bar" mode="determinate" [value]="exportTotal ? (exportProgress / exportTotal) * 100 : 0"></mat-progress-bar>
      <div class="export-status">{{ exportProgress }} / {{ exportTotal }} (<span class="percent">{{ exportPercent }}%</span>)</div>
    </div>

    <mat-spinner *ngIf="isLoading" diameter="40" class="spinner"></mat-spinner>

    <div *ngIf="(parsedUserStories.length || 0) > 0 || parseError" class="results">
      <div *ngIf="parseError" class="warning-message">
        <p>The model returned non-JSON output; showing raw text. Parse error: {{ parseError }}</p>
        <pre>{{ userStories }}</pre>
      </div>

      <div *ngIf="(parsedUserStories.length || 0) > 0">
        <h3>Generated User Stories</h3>
        <div class="user-stories-container">
          <mat-card *ngFor="let story of parsedUserStories; let i = index" class="user-story-card">
            <div class="card-head">
              <span class="id-badge">{{ story.id || story.ID || ('US_' + (i + 1)) }}</span>
              <span class="priority-pill" *ngIf="story.priority" [ngClass]="'priority-' + (story.priority | lowercase)">{{ story.priority }}</span>
            </div>

            <mat-card-content>
              <h4 class="story-title">{{ story.title || ('User Story ' + (i + 1)) }}</h4>

              <div class="story-summary" *ngIf="story.story">
                <div class="story-text">{{ story.story }}</div>
              </div>

              <div class="acceptance-box" *ngIf="story.acceptance_criteria">
                <div class="acceptance-title">Acceptance Criteria</div>
                <ul>
                  <li *ngFor="let criteria of (Array.isArray(story.acceptance_criteria) ? story.acceptance_criteria : [story.acceptance_criteria])">
                    <span class="check">‚úì</span>
                    <span class="criteria-text">{{ criteria }}</span>
                  </li>
                </ul>
              </div>

              <div class="meta-row">
                <div class="meta-col">
                  <div class="meta-label">STORY POINTS</div>
                  <div class="meta-value">{{ story.story_points ?? story.storyPoints ?? '-' }}</div>
                </div>
                <div class="meta-col right">
                  <div class="meta-label">CATEGORY</div>
                  <div class="meta-value"><span class="category-badge">{{ story.category || '-' }}</span></div>
                </div>
              </div>

              <div class="notes-box" *ngIf="story.notes">
                <div class="notes-title">üìù Notes</div>
                <ul>
                  <li *ngFor="let note of (Array.isArray(story.notes) ? story.notes : [story.notes])">{{ note }}</li>
                </ul>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <mat-card class="quality-assessment-card" *ngIf="qualityAssessment">
        <mat-card-header>
          <mat-card-title>Quality Assessment</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="quality-field" *ngIf="qualityAssessment.completeness">
            <strong>Completeness:</strong> {{ qualityAssessment.completeness }}
          </div>
          <div class="quality-field" *ngIf="qualityAssessment.clarity">
            <strong>Clarity:</strong> {{ qualityAssessment.clarity }}
          </div>
          <div class="quality-field" *ngIf="qualityAssessment.testability">
            <strong>Testability:</strong> {{ qualityAssessment.testability }}
          </div>
          <div class="quality-field" *ngIf="qualityAssessment.overall_score">
            <strong>Overall Score:</strong> {{ qualityAssessment.overall_score }}
          </div>
          <div class="quality-field" *ngIf="qualityAssessment.recommendations">
            <strong>Recommendations:</strong>
            <ul *ngIf="Array.isArray(qualityAssessment.recommendations)">
              <li *ngFor="let rec of qualityAssessment.recommendations">{{ rec }}</li>
            </ul>
            <div *ngIf="!Array.isArray(qualityAssessment.recommendations)">{{ qualityAssessment.recommendations }}</div>
          </div>
        </mat-card-content>
      </mat-card>

      <p class="processing-time" *ngIf="processingTime !== null">
        <strong>Processing time:</strong> {{ processingTime }} seconds
      </p>
    </div>
  </div>
</div>
